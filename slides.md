title: Оптимизация производительности .NET
author:
  name: Квачук Григорий
  url: https://vcipher.github.com/perf-talks
output: index.html
style: style.css
controls: false

--

# Оптимизация 
## производительности приложений на .NET

--

# С чего начать?

--

### Как выявить узкое место?

* Требования к производительности

* Характеристики производительности

--

### Требования (неправильные)

* Высокая отзывчивость при одновременном доступе нескольких пользователей.

* Низкий объем потребления памяти при небольшом количестве посетителей.

--

### Требования (правильные)

|               |                                                       |              |
|---------------|-------------------------------------------------------|--------------|
| Веб-сервер    | Время на обработку запроса не более 300 мс            | Одновременно не более 300 запросов в секунду
| Клиентское приложение | Время запуска не должно превышать 1500 мс     | 8 Гб оперативной памяти
| Клиентское ПО | Нагрузка на ЦП в режиме простоя не должна превышать 1% | Процессор Intel Core i7 4790 3,6 ГГц или AMD FX-9590 4,7 ГГц 

--

### Характеристики

|                     |       
|---------------------|--------------------------------------------------
|Нагрузка на CPU      | %
|Использование памяти | Килобайты, мегабайты, гигабайты
|Время выполнения     | Миллисекунды
|Сборка мусора        | Продолжительность % от общего времени выполнения
|Попадания в кэш      | Количество попаданий в секунду

--

### Производительность в цикле разработки ПО

* Выделение требований по основным характеристикам производительности

* Тестирование прототипов на этапе разработки

* Нагрузочное тестирование системы перед каждым новым релизом

--

# 
## Построение догадок и преждевременных выводов об узких местах в приложении -
## **это самое худшее, что может сделать разработчик**

--

### Подходы к измерению производительности

* Счетчики производительности (performance counters)

* Различные профилировщики

* Микрохронометраж (microbenchmarking)

--

### Счетчики производительности

Windows Performance Counters (Утечка памяти)

<center>
    <img src="images/memory_leak.png">
</center>

--

### Счетчики производительности

```java
public class Program
{
    // Создание категории счетчика
    public static void CreateCounterCategory()
    {
        if (PerformanceCounterCategory.Exists("MyUsers"))
            PerformanceCounterCategory.Delete("MyUsers");

        CounterCreationDataCollection counters = new CounterCreationDataCollection
        {
            new CounterCreationData("# Пользователи онлайн", "Количество пользователей в приложении",
                PerformanceCounterType.NumberOfItems32)
        };

        PerformanceCounterCategory.Create("MyUsers", "Информация о пользователях онлайн", counters);
    }

    // Метод запуска счетчика
    public static void StartUpdatingCounters()
    {
        PerformanceCounter usersAtWork = new PerformanceCounter("MyUsers", "# Пользователи онлайн", false);

        Timer updateTimer = new Timer(_ => usersAtWork.RawValue = MyUsers.UsersCount, 
            null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }
}
```
---
